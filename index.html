<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Bütçe & Nakit Akış Yönetimi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 text-white flex-shrink-0 hidden md:flex flex-col transition-all duration-300" id="sidebar">
        <div class="p-6 border-b border-slate-700 flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-wallet"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight">ProBütçe</h1>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchView('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors text-left bg-slate-800 text-indigo-400">
                <i class="fa-solid fa-chart-pie w-5"></i> Genel Bakış
            </button>
            <button onclick="switchView('transactions')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors text-left text-slate-300">
                <i class="fa-solid fa-list w-5"></i> Harcamalar & Gelirler
            </button>
            <button onclick="switchView('categories')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors text-left text-slate-300">
                <i class="fa-solid fa-tags w-5"></i> Kategoriler & Limitler
            </button>
        </nav>

        <div class="p-4 border-t border-slate-700">
            <div class="bg-slate-800 rounded-lg p-3 text-xs text-slate-400">
                <p class="font-bold text-slate-200 mb-1">Kur Bilgisi (Manuel)</p>
                <div class="flex justify-between"><span>USD/TRY:</span> <span id="rate-try-disp">34.50</span></div>
                <div class="flex justify-between"><span>USD/RUB:</span> <span id="rate-rub-disp">92.00</span></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <!-- Header -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 flex-shrink-0">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-gray-600" onclick="document.getElementById('sidebar').classList.toggle('hidden')">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="text-xl font-semibold text-gray-800">Genel Bakış</h2>
            </div>

            <div class="flex items-center gap-3">
                <!-- Tarih Seçici -->
                <div class="flex bg-gray-100 rounded-lg p-1 gap-1">
                    <button onclick="changeDate(-1)" class="w-8 h-8 flex items-center justify-center rounded hover:bg-white shadow-sm transition"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="current-date-display" class="px-3 flex items-center font-medium text-sm w-32 justify-center">Ocak 2024</span>
                    <button onclick="changeDate(1)" class="w-8 h-8 flex items-center justify-center rounded hover:bg-white shadow-sm transition"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <!-- Görünüm Modu -->
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button onclick="setViewMode('monthly')" id="btn-monthly" class="px-3 py-1.5 text-xs font-medium rounded shadow-sm bg-white text-indigo-600">Aylık</button>
                    <button onclick="setViewMode('yearly')" id="btn-yearly" class="px-3 py-1.5 text-xs font-medium rounded text-gray-500 hover:text-gray-700">Yıllık</button>
                </div>

                <button onclick="generatePDFReport()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">Rapor İndir</span>
                </button>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6" id="content-area">
            
            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-panel p-5 rounded-xl border-l-4 border-emerald-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Toplam Gelir</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-income">$0.00</h3>
                            </div>
                            <div class="p-2 bg-emerald-100 text-emerald-600 rounded-lg">
                                <i class="fa-solid fa-arrow-trend-up"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel p-5 rounded-xl border-l-4 border-rose-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Toplam Gider</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-expense">$0.00</h3>
                            </div>
                            <div class="p-2 bg-rose-100 text-rose-600 rounded-lg">
                                <i class="fa-solid fa-arrow-trend-down"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel p-5 rounded-xl border-l-4 border-indigo-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Net Durum</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-net">$0.00</h3>
                            </div>
                            <div class="p-2 bg-indigo-100 text-indigo-600 rounded-lg">
                                <i class="fa-solid fa-wallet"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Area -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-panel p-5 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">Harcama Dağılımı (Kategori)</h3>
                        <div class="h-64">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-panel p-5 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">Gelir vs Gider Trendi</h3>
                        <div class="h-64">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Treasury Preview (Mini) -->
                <div class="glass-panel p-5 rounded-xl">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Cüzdan Durumu (Orijinal Para Birimleri)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="treasury-preview">
                        <!-- JS ile doldurulacak -->
                    </div>
                </div>
            </div>

            <!-- TRANSACTIONS VIEW -->
            <div id="view-transactions" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-700">İşlem Geçmişi</h3>
                    <button onclick="openModal('modal-transaction')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm">
                        <i class="fa-solid fa-plus mr-2"></i> Yeni İşlem
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3">Tarih</th>
                                    <th class="px-6 py-3">Kategori</th>
                                    <th class="px-6 py-3">Açıklama</th>
                                    <th class="px-6 py-3 text-right">Tutar (Orijinal)</th>
                                    <th class="px-6 py-3 text-right">Tutar (USD)</th>
                                    <th class="px-6 py-3 text-center">İşlem</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body">
                                <!-- JS ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CATEGORIES VIEW -->
            <div id="view-categories" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-700">Kategori Yönetimi & Hedefler</h3>
                    <button onclick="openModal('modal-category')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm">
                        <i class="fa-solid fa-plus mr-2"></i> Yeni Kategori
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gider Kategorileri -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h4 class="font-semibold text-rose-600 mb-4 border-b pb-2">Gider Kategorileri</h4>
                        <div id="cat-list-expense" class="space-y-3"></div>
                    </div>
                    <!-- Gelir Kategorileri -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h4 class="font-semibold text-emerald-600 mb-4 border-b pb-2">Gelir Kategorileri</h4>
                        <div id="cat-list-income" class="space-y-3"></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- MODAL: ADD TRANSACTION -->
    <div id="modal-transaction" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Yeni İşlem Ekle</h3>
                <button onclick="closeModal('modal-transaction')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="form-transaction" onsubmit="handleTransactionSubmit(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Tip</label>
                        <select id="tx-type" onchange="updateCategorySelect()" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                            <option value="expense">Gider</option>
                            <option value="income">Gelir</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Tarih</label>
                        <input type="date" id="tx-date" required class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="tx-category" required class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        <!-- JS ile dolacak -->
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Tutar</label>
                        <input type="number" id="tx-amount" step="0.01" required class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Para Birimi</label>
                        <select id="tx-currency" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                            <option value="USD">USD ($)</option>
                            <option value="TRY">TRY (₺)</option>
                            <option value="RUB">RUB (₽)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Açıklama</label>
                    <input type="text" id="tx-desc" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border" placeholder="Örn: Market alışverişi">
                </div>

                <button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-medium hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- MODAL: ADD CATEGORY -->
    <div id="modal-category" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Yeni Kategori</h3>
                <button onclick="closeModal('modal-category')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="form-category" onsubmit="handleCategorySubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Kategori Adı</label>
                    <input type="text" id="cat-name" required class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Tip</label>
                    <select id="cat-type" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                        <option value="expense">Gider</option>
                        <option value="income">Gelir</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Aylık Hedef ($)</label>
                        <input type="number" id="cat-plan-monthly" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Yıllık Hedef ($)</label>
                        <input type="number" id="cat-plan-yearly" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border" placeholder="0">
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-medium hover:bg-indigo-700 transition">Oluştur</button>
            </form>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-50">
        <i class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toast-msg">İşlem Başarılı</span>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || [
            { id: 1, name: 'Maaş', type: 'income', monthlyPlan: 3000, yearlyPlan: 36000 },
            { id: 2, name: 'Kira', type: 'expense', monthlyPlan: 800, yearlyPlan: 9600 },
            { id: 3, name: 'Market', type: 'expense', monthlyPlan: 400, yearlyPlan: 4800 },
            { id: 4, name: 'Eğlence', type: 'expense', monthlyPlan: 200, yearlyPlan: 2400 },
        ];
        
        // Sabit Kurlar (Simülasyon için)
        const exchangeRates = {
            USD: 1,
            TRY: 34.50,
            RUB: 92.00
        };

        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let viewMode = 'monthly'; // 'monthly' or 'yearly'

        // Chart Instances
        let expenseChartInstance = null;
        let trendChartInstance = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

        function init() {
            updateDateDisplay();
            updateDashboard();
            updateCategorySelect();
            
            // Set default date in modal
            document.getElementById('tx-date').valueAsDate = new Date();
        }

        // --- CORE LOGIC ---

        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('categories', JSON.stringify(categories));
            updateDashboard();
        }

        function handleTransactionSubmit(e) {
            e.preventDefault();
            const type = document.getElementById('tx-type').value;
            const date = document.getElementById('tx-date').value;
            const categoryId = parseInt(document.getElementById('tx-category').value);
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const currency = document.getElementById('tx-currency').value;
            const desc = document.getElementById('tx-desc').value;

            // Convert to USD
            const rate = exchangeRates[currency];
            const amountUSD = amount / rate;

            const newTx = {
                id: Date.now(),
                date,
                type,
                categoryId,
                amount, // Orijinal tutar
                currency, // Orijinal para birimi
                amountUSD, // Raporlama için USD karşılığı
                desc
            };

            transactions.push(newTx);
            saveData();
            closeModal('modal-transaction');
            e.target.reset();
            document.getElementById('tx-date').valueAsDate = new Date(); // Reset date
            showToast('İşlem başarıyla eklendi');
        }

        function handleCategorySubmit(e) {
            e.preventDefault();
            const name = document.getElementById('cat-name').value;
            const type = document.getElementById('cat-type').value;
            const mPlan = parseFloat(document.getElementById('cat-plan-monthly').value) || 0;
            const yPlan = parseFloat(document.getElementById('cat-plan-yearly').value) || 0;

            const newCat = {
                id: Date.now(),
                name,
                type,
                monthlyPlan: mPlan,
                yearlyPlan: yPlan
            };

            categories.push(newCat);
            saveData();
            closeModal('modal-category');
            e.target.reset();
            showToast('Kategori oluşturuldu');
        }

        function deleteTransaction(id) {
            if(confirm('Bu işlemi silmek istediğinize emin misiniz?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                showToast('İşlem silindi');
            }
        }

        function updateCategoryPlan(id, field, value) {
            const cat = categories.find(c => c.id === id);
            if(cat) {
                cat[field] = parseFloat(value) || 0;
                saveData();
            }
        }

        // --- VIEW & UI UPDATES ---

        function switchView(viewName) {
            // Hide all views
            ['dashboard', 'transactions', 'categories'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });
            // Show selected
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-slate-800', 'text-indigo-400');
                el.classList.add('text-slate-300');
            });
            
            // Find the clicked button (simple logic for demo)
            const btnIndex = {'dashboard':0, 'transactions':1, 'categories':2}[viewName];
            const activeBtn = document.querySelectorAll('.nav-item')[btnIndex];
            if(activeBtn) {
                activeBtn.classList.add('bg-slate-800', 'text-indigo-400');
                activeBtn.classList.remove('text-slate-300');
            }

            // Update Header Title
            const titles = {'dashboard': 'Genel Bakış', 'transactions': 'Harcamalar', 'categories': 'Kategoriler'};
            document.getElementById('page-title').innerText = titles[viewName];

            // Refresh specific view data
            if(viewName === 'transactions') renderTransactionsTable();
            if(viewName === 'categories') renderCategoriesList();
        }

        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('btn-monthly').className = mode === 'monthly' 
                ? "px-3 py-1.5 text-xs font-medium rounded shadow-sm bg-white text-indigo-600"
                : "px-3 py-1.5 text-xs font-medium rounded text-gray-500 hover:text-gray-700";
            
            document.getElementById('btn-yearly').className = mode === 'yearly' 
                ? "px-3 py-1.5 text-xs font-medium rounded shadow-sm bg-white text-indigo-600"
                : "px-3 py-1.5 text-xs font-medium rounded text-gray-500 hover:text-gray-700";
            
            updateDateDisplay();
            updateDashboard();
        }

        function changeDate(delta) {
            if (viewMode === 'monthly') {
                currentMonth += delta;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            } else {
                currentYear += delta;
            }
            updateDateDisplay();
            updateDashboard();
        }

        function updateDateDisplay() {
            const months = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            const text = viewMode === 'monthly' ? `${months[currentMonth]} ${currentYear}` : `${currentYear}`;
            document.getElementById('current-date-display').innerText = text;
        }

        function getFilteredTransactions() {
            return transactions.filter(t => {
                const d = new Date(t.date);
                if (viewMode === 'monthly') {
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                } else {
                    return d.getFullYear() === currentYear;
                }
            });
        }

        function updateDashboard() {
            const filtered = getFilteredTransactions();
            
            // 1. Totals (USD)
            const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
            const expense = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
            const net = income - expense;

            document.getElementById('dash-income').innerText = `$${income.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('dash-expense').innerText = `$${expense.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('dash-net').innerText = `$${net.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('dash-net').className = `text-2xl font-bold mt-1 ${net >= 0 ? 'text-gray-800' : 'text-red-600'}`;

            // 2. Treasury Preview (Original Currencies)
            const treasury = { USD: 0, TRY: 0, RUB: 0 };
            filtered.forEach(t => {
                if(t.type === 'expense') treasury[t.currency] -= t.amount;
                else treasury[t.currency] += t.amount;
            });
            
            const treasuryHTML = Object.keys(treasury).map(curr => {
                const val = treasury[curr];
                const color = val >= 0 ? 'text-emerald-600' : 'text-rose-600';
                const icon = curr === 'USD' ? '$' : (curr === 'TRY' ? '₺' : '₽');
                return `
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div class="text-xs text-gray-500 font-bold">${curr} Net</div>
                        <div class="${color} font-mono font-bold text-lg">${val > 0 ? '+' : ''}${val.toLocaleString()} ${icon}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('treasury-preview').innerHTML = treasuryHTML;

            // 3. Charts
            updateCharts(filtered);
            
            // Update tables if visible
            if(!document.getElementById('view-transactions').classList.contains('hidden')) renderTransactionsTable();
        }

        function updateCharts(data) {
            // Expense by Category
            const expenseCats = {};
            data.filter(t => t.type === 'expense').forEach(t => {
                const catName = categories.find(c => c.id === t.categoryId)?.name || 'Diğer';
                expenseCats[catName] = (expenseCats[catName] || 0) + t.amountUSD;
            });

            const ctxExp = document.getElementById('expenseChart').getContext('2d');
            if (expenseChartInstance) expenseChartInstance.destroy();
            
            expenseChartInstance = new Chart(ctxExp, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseCats),
                    datasets: [{
                        data: Object.values(expenseCats),
                        backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#64748b', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            // Trend Chart (Basitçe son 6 ay veya yılın ayları)
            // Bu örnekte mevcut yılın aylarını gösterelim
            const monthlyData = Array(12).fill(0).map(() => ({ income: 0, expense: 0 }));
            
            transactions.filter(t => new Date(t.date).getFullYear() === currentYear).forEach(t => {
                const m = new Date(t.date).getMonth();
                if (t.type === 'income') monthlyData[m].income += t.amountUSD;
                else monthlyData[m].expense += t.amountUSD;
            });

            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(ctxTrend, {
                type: 'bar',
                data: {
                    labels: ["Oca", "Şub", "Mar", "Nis", "May", "Haz", "Tem", "Ağu", "Eyl", "Eki", "Kas", "Ara"],
                    datasets: [
                        { label: 'Gelir', data: monthlyData.map(d => d.income), backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'Gider', data: monthlyData.map(d => d.expense), backgroundColor: '#f43f5e', borderRadius: 4 }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });
        }

        function renderTransactionsTable() {
            const filtered = getFilteredTransactions().sort((a,b) => new Date(b.date) - new Date(a.date));
            const tbody = document.getElementById('transactions-table-body');
            tbody.innerHTML = '';

            filtered.forEach(t => {
                const cat = categories.find(c => c.id === t.categoryId);
                const colorClass = t.type === 'income' ? 'text-emerald-600' : 'text-rose-600';
                const sign = t.type === 'income' ? '+' : '-';
                
                const row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4">${new Date(t.date).toLocaleDateString('tr-TR')}</td>
                        <td class="px-6 py-4"><span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded">${cat ? cat.name : 'Silinmiş'}</span></td>
                        <td class="px-6 py-4 font-medium text-gray-900">${t.desc || '-'}</td>
                        <td class="px-6 py-4 text-right font-mono text-xs text-gray-500">${t.amount.toLocaleString()} ${t.currency}</td>
                        <td class="px-6 py-4 text-right font-bold ${colorClass}">${sign}$${t.amountUSD.toFixed(2)}</td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="deleteTransaction(${t.id})" class="text-gray-400 hover:text-red-600 transition"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function renderCategoriesList() {
            const types = ['expense', 'income'];
            
            types.forEach(type => {
                const container = document.getElementById(`cat-list-${type}`);
                container.innerHTML = '';
                
                categories.filter(c => c.type === type).forEach(c => {
                    const html = `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                            <div class="font-medium text-gray-700 w-1/3">${c.name}</div>
                            <div class="flex gap-2 w-2/3">
                                <div class="w-1/2">
                                    <label class="text-[10px] text-gray-400 block">Aylık Hedef ($)</label>
                                    <input type="number" value="${c.monthlyPlan}" onchange="updateCategoryPlan(${c.id}, 'monthlyPlan', this.value)" class="w-full text-sm bg-white border border-gray-200 rounded px-2 py-1 focus:ring-1 focus:ring-indigo-500">
                                </div>
                                <div class="w-1/2">
                                    <label class="text-[10px] text-gray-400 block">Yıllık Hedef ($)</label>
                                    <input type="number" value="${c.yearlyPlan}" onchange="updateCategoryPlan(${c.id}, 'yearlyPlan', this.value)" class="w-full text-sm bg-white border border-gray-200 rounded px-2 py-1 focus:ring-1 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            });
        }

        function updateCategorySelect() {
            const type = document.getElementById('tx-type').value;
            const select = document.getElementById('tx-category');
            select.innerHTML = '';
            
            categories.filter(c => c.type === type).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.innerText = c.name;
                select.appendChild(opt);
            });
        }

        // --- HELPER FUNCTIONS ---
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            if(id === 'modal-transaction') updateCategorySelect();
        }
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                t.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        
        // Helper for PDF report to get plan
        function getCategoryMonthlyPlan(cat, month) { return cat.monthlyPlan || 0; }
        function getCategoryYearlyPlan(cat) { return cat.yearlyPlan || 0; }
        function getYearTransactions() { return transactions.filter(t => new Date(t.date).getFullYear() === currentYear); }
        function getRateForMonth(curr, month) { return exchangeRates[curr] || 1; } // Simplified for this demo

        // ==================== GRAFİKLİ PDF RAPORU ====================
        function generatePDFReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Font Ayarı
            doc.setFont("helvetica");

            const isMonthly = viewMode === 'monthly';
            const yearTx = getYearTransactions();
            const monthNamesFull = ["Ocak", "Subat", "Mart", "Nisan", "Mayis", "Haziran", "Temmuz", "Agustos", "Eylul", "Ekim", "Kasim", "Aralik"];
            
            // Kurlar
            const tryRate = exchangeRates.TRY;
            const rubRate = exchangeRates.RUB;

            // Renk Paleti
            const colorMain = [79, 70, 229];    // Indigo
            const colorIncome = [16, 185, 129];   // Emerald
            const colorExpense = [244, 63, 94]; // Rose
            const colorWarning = [245, 158, 11]; // Amber

            // --- BAŞLIK ALANI ---
            doc.setFillColor(...colorMain);
            doc.rect(0, 0, 210, 45, 'F'); 
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("Stratejik Butce Raporu", 14, 20);
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            const dateStr = isMonthly 
                ? `${monthNamesFull[currentMonth]} ${currentYear} Detayli Analizi` 
                : `${currentYear} Yili Genel Analizi`;
            doc.text(dateStr, 14, 32);
            
            doc.setFontSize(9);
            doc.text(`Olusturulma: ${new Date().toLocaleDateString('tr-TR')} - Kur: 1$ = ${tryRate.toFixed(2)}TL / ${rubRate.toFixed(2)}RUB`, 14, 40);

            // --- HESAPLAMALAR ---
            // Yıllık Toplamlar (Forecast için gerekli)
            const yearlyPlanExpense = categories.filter(c => c.type === 'expense').reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
            const yearlyFactExpense = yearTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);

            // 2. Döviz Bazlı Nakit Akışı (Treasury)
            const treasury = {
                USD: { income: 0, expense: 0, net: 0 },
                TRY: { income: 0, expense: 0, net: 0 },
                RUB: { income: 0, expense: 0, net: 0 }
            };

            const activeTxList = isMonthly 
                ? yearTx.filter(t => new Date(t.date).getMonth() === currentMonth)
                : yearTx;

            activeTxList.forEach(t => {
                if (treasury[t.currency]) {
                    if (t.type === 'income') treasury[t.currency].income += t.amount;
                    else treasury[t.currency].expense += t.amount;
                }
            });

            ['USD', 'TRY', 'RUB'].forEach(curr => {
                treasury[curr].net = treasury[curr].income - treasury[curr].expense;
            });

            // --- BÖLÜM 1: NAKİT AKIŞI & REZERV ---
            let currentY = 55;
            
            doc.setFontSize(14);
            doc.setTextColor(...colorMain);
            doc.text("1. Nakit Akisi ve Doviz Ihtiyaci (Treasury)", 14, currentY);
            
            const treasuryBody = [
                ['Para Birimi', 'Toplam Gelir', 'Toplam Gider', 'Net Nakit Degisimi'],
                ['USD ($)', `$${treasury.USD.income.toFixed(2)}`, `$${treasury.USD.expense.toFixed(2)}`, `${treasury.USD.net >= 0 ? '+' : ''}$${treasury.USD.net.toFixed(2)}`],
                ['TRY (TL)', `TL ${treasury.TRY.income.toFixed(2)}`, `TL ${treasury.TRY.expense.toFixed(2)}`, `${treasury.TRY.net >= 0 ? '+' : ''}TL ${treasury.TRY.net.toFixed(2)}`],
                ['RUB (Ruble)', `RUB ${treasury.RUB.income.toFixed(2)}`, `RUB ${treasury.RUB.expense.toFixed(2)}`, `${treasury.RUB.net >= 0 ? '+' : ''}RUB ${treasury.RUB.net.toFixed(2)}`]
            ];

            doc.autoTable({
                startY: currentY + 5,
                head: [treasuryBody[0]],
                body: treasuryBody.slice(1),
                theme: 'grid',
                headStyles: { fillColor: colorMain, textColor: 255, fontStyle: 'bold' },
                columnStyles: { 0: { fontStyle: 'bold' }, 3: { fontStyle: 'bold' } },
                styles: { fontSize: 10, cellPadding: 4 },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 3) {
                        const val = parseFloat(data.cell.raw.replace(/[^0-9.-]+/g,""));
                        if (val < 0) data.cell.styles.textColor = colorExpense;
                        else data.cell.styles.textColor = colorIncome;
                    }
                }
            });

            currentY = doc.lastAutoTable.finalY + 15;

            // --- BÖLÜM 2: FORECAST & TREND ---
            doc.setFontSize(14);
            doc.setTextColor(...colorMain);
            doc.text("2. Finansal Ongoru ve Trend Analizi", 14, currentY);

            const passedMonths = currentMonth + 1; 
            const remainingMonths = 12 - passedMonths;
            const avgMonthlyExpense = yearlyFactExpense / (passedMonths || 1);
            const projectedYearlyExpense = yearlyFactExpense + (avgMonthlyExpense * remainingMonths);
            const remainingBudget = yearlyPlanExpense - yearlyFactExpense;
            const monthlyAllowableExpense = remainingMonths > 0 ? remainingBudget / remainingMonths : 0;
            const trendStatus = projectedYearlyExpense > yearlyPlanExpense ? "RISKLI" : "GUVENLI";
            const trendDiff = yearlyPlanExpense - projectedYearlyExpense;

            const forecastBody = [
                ['Analiz Metrigi', 'Deger ($ USD)', 'Aciklama'],
                ['Yillik Toplam Hedef', `$${yearlyPlanExpense.toFixed(0)}`, 'Sene basinda belirlenen toplam butce'],
                ['Bugune Kadar Harcanan', `$${yearlyFactExpense.toFixed(0)}`, `${passedMonths} ayda harcanan toplam`],
                ['Kalan Butce', `$${remainingBudget.toFixed(0)}`, 'Yil sonuna kadar kalan limit'],
                ['Mevcut Aylik Ort. Harcama', `$${avgMonthlyExpense.toFixed(0)}`, 'Mevcut harcama hizi'],
                ['Kalan Aylar Icin Limit', `$${monthlyAllowableExpense.toFixed(0)}`, 'Hedefi tutturmak icin aylik max harcama'],
                ['Yil Sonu Tahmini', `$${projectedYearlyExpense.toFixed(0)}`, 'Harcama hizi degismezse yil sonu toplami'],
                ['Trend Sonucu', `${trendDiff >= 0 ? '+' : ''}$${trendDiff.toFixed(0)}`, trendStatus === "RISKLI" ? "Butce ASILACAK!" : "Butce ICI kalinacak."]
            ];

            doc.autoTable({
                startY: currentY + 5,
                head: [forecastBody[0]],
                body: forecastBody.slice(1),
                theme: 'striped',
                headStyles: { fillColor: [60, 60, 60] },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 60 }, 1: { halign: 'right', fontStyle: 'bold', cellWidth: 40 } },
                styles: { fontSize: 9 },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.row.index === 6) { // Trend satırı
                        if (trendStatus === "RISKLI") {
                            data.cell.styles.fillColor = [255, 230, 230];
                            data.cell.styles.textColor = colorExpense;
                        } else {
                            data.cell.styles.fillColor = [230, 255, 230];
                            data.cell.styles.textColor = colorIncome;
                        }
                    }
                }
            });

            currentY = doc.lastAutoTable.finalY + 15;
            
            // --- BÖLÜM 3: DETAYLI GİDER ANALİZİ ---
            // Eğer sayfa sonuna yaklaştıysak yeni sayfa
            if (currentY > 220) { doc.addPage(); currentY = 20; }

            doc.setFontSize(14);
            doc.setTextColor(...colorExpense);
            doc.text("3. Gider Kalemleri Detay ve Orijinal Harcamalar", 14, currentY);

            const expenseData = categories.filter(c => c.type === 'expense').map(cat => {
                const plan = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);
                const txList = isMonthly
                    ? yearTx.filter(t => t.categoryId === cat.id && new Date(t.date).getMonth() === currentMonth)
                    : yearTx.filter(t => t.categoryId === cat.id);
                
                const fact = txList.reduce((sum, t) => sum + t.amountUSD, 0);
                const diff = plan - fact; 
                const percent = plan > 0 ? (fact / plan) * 100 : 0;
                
                let originalText = "";
                const currencies = {};
                txList.forEach(t => { currencies[t.currency] = (currencies[t.currency] || 0) + t.amount; });
                
                const parts = [];
                if(currencies.TRY) parts.push(`${currencies.TRY.toFixed(0)} TL`);
                if(currencies.RUB) parts.push(`${currencies.RUB.toFixed(0)} RUB`);
                if(currencies.USD) parts.push(`${currencies.USD.toFixed(0)} $`);
                originalText = parts.length > 0 ? parts.join(', ') : '-';

                return [
                    cat.name, 
                    `$${plan.toFixed(0)}`, 
                    `$${fact.toFixed(0)}`, 
                    `%${percent.toFixed(0)}`,
                    `${diff >= 0 ? '' : '-'}$${Math.abs(diff).toFixed(0)}`,
                    originalText
                ];
            });

            doc.autoTable({
                startY: currentY + 5,
                head: [['Kategori', 'Hedef', 'Gercek', 'Oran', 'Kalan/Asim', 'Orijinal Harcama Detayi']],
                body: expenseData,
                theme: 'grid',
                headStyles: { fillColor: colorExpense },
                styles: { fontSize: 8, cellPadding: 3 },
                columnStyles: {
                    1: { halign: 'right' }, 2: { halign: 'right' }, 3: { halign: 'center' },
                    4: { halign: 'right', fontStyle: 'bold' },
                    5: { fontSize: 7, fontStyle: 'italic', textColor: [100,100,100] }
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 4) {
                        const text = data.cell.raw;
                        if (text.startsWith('-')) data.cell.styles.textColor = colorExpense; 
                        else data.cell.styles.textColor = colorIncome; 
                    }
                }
            });

            // --- BÖLÜM 4: GÖRSEL ÖZET (GRAFİKLER) ---
            doc.addPage();
            doc.setFontSize(14);
            doc.setTextColor(...colorMain);
            doc.text("4. Gorsel Ozet (Grafikler)", 14, 20);

            // 1. Expense Chart (Pie/Doughnut)
            const canvasExp = document.getElementById('expenseChart');
            if(canvasExp) {
                // Canvas'ı resme çevir
                const imgExp = canvasExp.toDataURL('image/png');
                // PDF'e ekle (x, y, width, height)
                doc.addImage(imgExp, 'PNG', 15, 30, 80, 80);
                
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Harcama Dagilimi", 55, 115, { align: 'center' });
            }

            // 2. Trend Chart (Bar)
            const canvasTrend = document.getElementById('trendChart');
            if(canvasTrend) {
                const imgTrend = canvasTrend.toDataURL('image/png');
                // Aspect ratio'yu korumak veya sığdırmak için boyutları ayarla
                doc.addImage(imgTrend, 'PNG', 105, 45, 90, 50);
                
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Gelir / Gider Trendi", 150, 115, { align: 'center' });
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('ProButce Stratejik Raporu', 14, 290);
                doc.text(`Sayfa ${i} / ${pageCount}`, 196, 290, { align: 'right' });
            }

            const filename = isMonthly
                ? `Butce_Analiz_${currentYear}_${String(currentMonth + 1).padStart(2, '0')}.pdf`
                : `Butce_Yillik_Analiz_${currentYear}.pdf`;

            doc.save(filename);
            showToast('Grafikli Rapor Oluşturuldu ✓');
        }

    </script>
</body>
</html>
